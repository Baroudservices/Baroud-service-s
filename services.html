<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Services - Baroud</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: #0b1020;
      color: #fff;
      margin: 0;
      padding: 0;
    }

    .wrap{
      max-width: 420px;
      margin: 0 auto;
      padding: 26px 16px 90px;
    }

    .card{
      background: rgba(255,255,255,0.06);
      border-radius: 22px;
      padding: 18px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.35);
    }

    h2{
      margin: 6px 0 14px;
      text-align: center;
      font-size: 30px;
      letter-spacing: .5px;
    }

    #welcome{
      text-align:center;
      opacity:.9;
      margin-bottom: 14px;
      font-size: 16px;
    }

    button{
      width: 100%;
      padding: 16px;
      margin-top: 12px;
      border: 0;
      border-radius: 18px;
      background: rgba(255,255,255,0.08);
      color: #fff;
      font-size: 18px;
      cursor: pointer;
    }
    button:active{ transform: scale(.99); }

    #msg{
      margin-top: 14px;
      text-align:center;
      font-weight: 700;
      opacity: .9;
    }

    #addCreditBtn{
      position: fixed;
      right: 18px;
      bottom: 18px;
      width: 62px;
      height: 62px;
      border-radius: 50%;
      background: #000;
      color: #fff;
      font-size: 34px;
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow: 0 12px 28px rgba(0,0,0,.45);
    }
  </style>
</head>

<body>
  <button id="addCreditBtn" onclick="goToAddCredit()">+</button>

  <div class="wrap">
    <div class="card">
      <h2>Baroud Services</h2>
      <div id="welcome">...</div>

      <a href="https://wa.me/96170385390" target="_blank" style="text-decoration:none;">
        <button type="button">WhatsApp</button>
      </a>

      <button type="button" onclick="alert('Service 1')">Service 1</button>
      <button type="button" onclick="alert('Service 2')">Service 2</button>

      <button type="button" onclick="logoutUser()">Logout</button>

      <div id="msg">...</div>
    </div>
  </div>

  <script>
    const BASE = "https://udservices.github.io/Baroud-service-s/";

    const supabase = window.supabase.createClient(
      "https://pqrwitolonhfbfwtsnde.supabase.co",
      "sb_publishable_l5PtPu6xVyWq2pD6jzEYRw_CYEQ9-f_"
    );

    const welcomeEl = document.getElementById("welcome");
    const msgEl = document.getElementById("msg");

    async function guard(){
      const { data } = await supabase.auth.getSession();
      const user = data?.session?.user;

      if(!user){
        window.location.replace(BASE + "index.html?v=" + Date.now());
        return;
      }

      welcomeEl.innerText = "أهلاً " + (user.email || "");
      msgEl.innerText = "Ready ✅";
    }

    async function logoutUser(){
      await supabase.auth.signOut();
      window.location.replace(BASE + "index.html?v=" + Date.now());
    }

    function goToAddCredit(){
      window.location.assign(BASE + "add-credit.html?v=" + Date.now());
    }

    // ✅ حل جذري ضد النسخة القديمة:
    // - امسح Service Workers و الكاش كل مرة تفتح الصفحة
    (async function killCache(){
      try{
        if ('serviceWorker' in navigator) {
          const regs = await navigator.serviceWorker.getRegistrations();
          for (const r of regs) await r.unregister();
        }
        if (window.caches) {
          const keys = await caches.keys();
          for (const k of keys) await caches.delete(k);
        }
      }catch(e){}
    })();

    guard();
  </script>
</body>
</html>
